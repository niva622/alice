<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–í–æ–ª—à–µ–±–Ω–∞—è –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞ üåü ‚Äî v2</title>
  <style>
    :root {
      --bg1: #667eea;
      --bg2: #764ba2;
      --ok1: #43e97b;
      --ok2: #38f9d7;
      --err1: #ff6b6b;
      --err2: #ff8e53;
      --brand1: #f093fb;
      --brand2: #f5576c;
      --text: #2a2a2a;
      --muted: #666;
      --card: #fff;
      --shadow: 0 20px 60px rgba(0,0,0,.28);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    html, body { height: 100%; }

    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Noto Sans', 'Comic Sans MS', cursive, sans-serif;
      background: linear-gradient(135deg, var(--bg1) 0%, var(--bg2) 100%);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
      color: var(--text);
    }

    .container { width: min(100%, 960px); }

    .header { text-align: center; color: white; margin-bottom: 24px; animation: bounce 2s infinite; }

    .header h1 { letter-spacing: .5px; }

    @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

    .mascot { width: 90px; height: 90px; margin: 12px auto; animation: float 3s ease-in-out infinite; }
    @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-16px); } }

    .game-stats { display: grid; grid-template-columns: repeat(4, minmax(0, 1fr)); gap: 14px; margin-bottom: 22px; }

    .stat-card { background: var(--card); border-radius: 18px; padding: 14px 18px; box-shadow: 0 10px 30px rgba(0,0,0,.20); display: flex; align-items: center; gap: 10px; transition: transform .2s ease; }
    .stat-card:hover { transform: translateY(-3px); }
    .stat-icon { font-size: 26px; }
    .stat-info h3 { font-size: 13px; color: var(--muted); margin-bottom: 4px; font-weight: 600; }
    .stat-value { font-size: 22px; font-weight: 800; color: var(--text); }

    .game-area { background: var(--card); border-radius: 28px; padding: clamp(20px, 4vw, 40px); box-shadow: var(--shadow); text-align: center; position: relative; overflow: hidden; }

    .level-indicator { position: absolute; inset: 16px 16px auto auto; background: linear-gradient(135deg, var(--brand1) 0%, var(--brand2) 100%); color: white; padding: 10px 16px; border-radius: 18px; font-weight: 800; box-shadow: 0 8px 22px rgba(0,0,0,.25); }

    .timer { position: absolute; inset: 16px auto auto 16px; background: #111; color: #fff; padding: 10px 14px; border-radius: 18px; font-weight: 800; letter-spacing: .5px; box-shadow: 0 8px 22px rgba(0,0,0,.25); }

    .question-container { margin: 22px 0; }
    .question { font-size: clamp(32px, 6vw, 52px); color: var(--text); margin-bottom: 18px; animation: slideIn .45s ease; font-weight: 900; }

    @keyframes slideIn { from { opacity: 0; transform: translateX(-30px); } to { opacity: 1; transform: translateX(0); } }

    .answers { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 14px; margin-top: 16px; }

    .answer-btn { background: linear-gradient(135deg, var(--ok1) 0%, var(--ok2) 100%); color: white; border: none; padding: 18px; font-size: clamp(20px, 4.5vw, 28px); border-radius: 18px; cursor: pointer; transition: transform .15s ease, box-shadow .15s ease, filter .15s ease; font-weight: 900; box-shadow: 0 5px 15px rgba(0,0,0,.2); user-select: none; }
    .answer-btn:hover { transform: translateY(-4px); box-shadow: 0 10px 24px rgba(0,0,0,.28); }
    .answer-btn:active { transform: scale(.97); }
    .answer-btn.correct { background: linear-gradient(135deg, #23d5ab 0%, #23a6d5 100%); animation: correctPulse .5s; }
    .answer-btn.wrong { background: linear-gradient(135deg, var(--err1) 0%, var(--err2) 100%); animation: shake .4s; }

    @keyframes correctPulse { 0% { transform: scale(1); } 50% { transform: scale(1.08); } 100% { transform: scale(1); } }
    @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-10px); } 75% { transform: translateX(10px); } }

    .progress-wrap { display: grid; grid-template-columns: 1fr auto; align-items: center; gap: 12px; margin-top: 18px; }
    .progress-bar { width: 100%; height: 26px; background: #f2f2f2; border-radius: 16px; overflow: hidden; }
    .progress-fill { height: 100%; background: linear-gradient(90deg, #f857a6 0%, #ff5858 100%); transition: width .45s ease; display: flex; align-items: center; justify-content: center; color: white; font-weight: 900; letter-spacing: .5px; }
    .progress-label { font-size: 14px; color: var(--muted); font-weight: 700; }

    .celebration { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 88px; animation: celebrate .9s ease-out; pointer-events: none; z-index: 1000; }
    @keyframes celebrate { 0% { opacity: 1; transform: translate(-50%, -50%) scale(0); } 50% { transform: translate(-50%, -50%) scale(1.35); } 100% { opacity: 0; transform: translate(-50%, -50%) scale(1.9); } }

    .start-screen { text-align: center; padding: clamp(16px, 4vw, 32px); }
    .start-btn { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: #111; border: none; padding: 18px 34px; font-size: 22px; border-radius: 28px; cursor: pointer; transition: transform .15s ease, box-shadow .2s ease; font-weight: 900; box-shadow: 0 10px 30px rgba(0,0,0,.3); margin-top: 18px; }
    .start-btn:hover { transform: translateY(-4px); box-shadow: 0 15px 40px rgba(0,0,0,.35); }

    .difficulty-select { display: flex; justify-content: center; gap: 12px; margin: 20px 0; flex-wrap: wrap; }
    .diff-btn { background: white; border: 3px solid #e6e6e6; padding: 12px 22px; border-radius: 18px; cursor: pointer; transition: all .2s; font-size: 16px; font-weight: 800; }
    .diff-btn.active { background: linear-gradient(135deg, var(--bg1) 0%, var(--bg2) 100%); color: white; border-color: transparent; }

    .hidden { display: none !important; }
    .streak-fire { display: inline-block; animation: fire 1s infinite; }
    @keyframes fire { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.15); } }

    /* iPad / mobile */
    @media (max-width: 768px) {
      .game-stats { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header" role="banner">
      <h1 aria-live="polite">üåü –í–æ–ª—à–µ–±–Ω–∞—è –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞ üåü</h1>
      <div class="mascot" aria-hidden="true">ü¶Ñ</div>
    </div>

    <div class="game-stats" aria-label="–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–≥—Ä—ã">
      <div class="stat-card" aria-live="polite">
        <span class="stat-icon">‚úÖ</span>
        <div class="stat-info">
          <h3>–ü—Ä–∞–≤–∏–ª—å–Ω–æ</h3>
          <div class="stat-value" id="correct-count">0</div>
        </div>
      </div>
      <div class="stat-card" aria-live="polite">
        <span class="stat-icon">‚ùå</span>
        <div class="stat-info">
          <h3>–û—à–∏–±–∫–∏</h3>
          <div class="stat-value" id="wrong-count">0</div>
        </div>
      </div>
      <div class="stat-card" aria-live="polite">
        <span class="stat-icon">‚≠ê</span>
        <div class="stat-info">
          <h3>–û—á–∫–∏</h3>
          <div class="stat-value" id="score">0</div>
        </div>
      </div>
      <div class="stat-card" aria-live="polite">
        <span class="stat-icon streak-fire">üî•</span>
        <div class="stat-info">
          <h3>–°–µ—Ä–∏—è</h3>
          <div class="stat-value" id="streak">0</div>
        </div>
      </div>
    </div>

    <div class="game-area" role="main">
      <div class="level-indicator" id="level-indicator">–£—Ä–æ–≤–µ–Ω—å 1</div>
      <div class="timer" id="timer" title="–¢–∞–π–º–µ—Ä –≤–æ–ø—Ä–æ—Å–∞">30s</div>

      <div id="start-screen" class="start-screen">
        <h2>–ü—Ä–∏–≤–µ—Ç! –î–∞–≤–∞–π —É—á–∏—Ç—å –º–∞—Ç–µ–º–∞—Ç–∏–∫—É –≤–µ—Å–µ–ª–æ! üéà</h2>
        <p style="margin: 16px 0; font-size: 18px; color: #666;">–í—ã–±–µ—Ä–∏ —Å–ª–æ–∂–Ω–æ—Å—Ç—å:</p>
        <div class="difficulty-select" role="group" aria-label="–í—ã–±–æ—Ä —Å–ª–æ–∂–Ω–æ—Å—Ç–∏">
          <button class="diff-btn active" data-diff="easy" aria-pressed="true">–õ–µ–≥–∫–æ üòä</button>
          <button class="diff-btn" data-diff="medium" aria-pressed="false">–°—Ä–µ–¥–Ω–µ ü§î</button>
          <button class="diff-btn" data-diff="hard" aria-pressed="false">–°–ª–æ–∂–Ω–æ üí™</button>
        </div>
        <button class="start-btn" id="start-btn" aria-label="–ù–∞—á–∞—Ç—å –∏–≥—Ä—É">–ù–∞—á–∞—Ç—å –∏–≥—Ä—É! üöÄ</button>
      </div>

      <div id="game-screen" class="hidden" aria-live="polite">
        <div class="question-container">
          <div class="question" id="question" aria-label="–í–æ–ø—Ä–æ—Å"></div>
        </div>
        <div class="answers" id="answers" role="group" aria-label="–í–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–æ–≤"></div>

        <div class="progress-wrap">
          <div class="progress-bar" aria-label="–ü—Ä–æ–≥—Ä–µ—Å—Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤">
            <div class="progress-fill" id="progress-fill">0%</div>
          </div>
          <div class="progress-label" id="progress-label">0 –∏–∑ 0</div>
        </div>
      </div>
    </div>
  </div>

  <template id="answer-template">
    <button class="answer-btn"></button>
  </template>

  <script>
    // --- –°–æ—Å—Ç–æ—è–Ω–∏–µ ---
    let state = {
      current: null,
      correctAnswer: null,
      score: 0,
      correct: 0,
      wrong: 0,
      streak: 0,
      level: 1,
      difficulty: 'easy',
      total: 0,
      timeLeft: 30,
      timerId: null,
    };

    const sounds = { correct: 'üéâ', wrong: 'üòî', levelUp: 'üéä' };

    // --- DOM ---
    const $ = (s) => document.querySelector(s);
    const $$ = (s) => document.querySelectorAll(s);
    const el = {
      start: $('#start-screen'),
      game: $('#game-screen'),
      q: $('#question'),
      answers: $('#answers'),
      correct: $('#correct-count'),
      wrong: $('#wrong-count'),
      score: $('#score'),
      streak: $('#streak'),
      progressFill: $('#progress-fill'),
      progressLabel: $('#progress-label'),
      level: $('#level-indicator'),
      timer: $('#timer'),
      startBtn: $('#start-btn'),
      diffBtns: $$('.diff-btn'),
      answerTpl: $('#answer-template'),
    };

    // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ---
    el.diffBtns.forEach((btn) => {
      btn.addEventListener('click', () => {
        el.diffBtns.forEach((b) => { b.classList.remove('active'); b.setAttribute('aria-pressed', 'false'); });
        btn.classList.add('active');
        btn.setAttribute('aria-pressed', 'true');
        state.difficulty = btn.dataset.diff;
      });
    });

    el.startBtn.addEventListener('click', startGame);
    window.addEventListener('keydown', (e) => {
      // –¶–∏—Ñ—Ä–æ–≤—ã–µ –≥–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏ 1-4 –¥–ª—è –æ—Ç–≤–µ—Ç–æ–≤
      if (el.game.classList.contains('hidden')) return;
      const idx = parseInt(e.key, 10) - 1;
      if (!Number.isNaN(idx)) {
        const btn = el.answers.children[idx];
        if (btn) btn.click();
      }
    });

    function startGame() {
      el.start.classList.add('hidden');
      el.game.classList.remove('hidden');
      resetRoundTimer();
      nextQuestion();
    }

    function resetRoundTimer() {
      clearInterval(state.timerId);
      state.timeLeft = 30; // —Å–µ–∫—É–Ω–¥ –Ω–∞ –≤–æ–ø—Ä–æ—Å
      renderTimer();
      state.timerId = setInterval(() => {
        state.timeLeft--;
        renderTimer();
        if (state.timeLeft <= 0) {
          clearInterval(state.timerId);
          // –∞–≤—Ç–æ-–ø—Ä–æ–≤–∞–ª –ø—Ä–∏ –∏—Å—Ç–µ—á–µ–Ω–∏–∏ –≤—Ä–µ–º–µ–Ω–∏
          markWrongDueToTime();
        }
      }, 1000);
    }

    function renderTimer() {
      el.timer.textContent = state.timeLeft + 's';
      el.timer.style.opacity = state.timeLeft <= 5 ? '1' : '.95';
      el.timer.style.transform = state.timeLeft <= 5 ? 'scale(1.05)' : 'scale(1)';
    }

    function nextQuestion() {
      const { num1, num2, op, answer } = makeTask(state.difficulty);
      state.current = `${num1} ${op} ${num2}`;
      state.correctAnswer = answer;
      el.q.textContent = `${num1} ${op} ${num2} = ?`;
      renderAnswers(answer);
      state.total++;
      resetRoundTimer();
    }

    function makeTask(diff) {
      let n1, n2, op, ans;

      switch (diff) {
        case 'easy': {
          // —á–∏—Å–ª–∞ 0..15, —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤—Å–µ–≥–¥–∞ –Ω–µ–æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π
          n1 = rnd(0, 15);
          n2 = rnd(0, 15);
          op = Math.random() < 0.5 ? '+' : '-';
          if (op === '-' && n2 > n1) [n1, n2] = [n2, n1];
          ans = op === '+' ? n1 + n2 : n1 - n2;
          break;
        }
        case 'medium': {
          // —á–∏—Å–ª–∞ 0..40, —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤—Å–µ–≥–¥–∞ –Ω–µ–æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π
          n1 = rnd(0, 40);
          n2 = rnd(0, 40);
          op = Math.random() < 0.5 ? '+' : '-';
          if (op === '-' && n2 > n1) [n1, n2] = [n2, n1];
          ans = op === '+' ? n1 + n2 : n1 - n2;
          break;
        }
        default: {
          // hard: —á–∏—Å–ª–∞ -50..50, –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ –¥–æ–ø—É—Å—Ç–∏–º—ã
          n1 = rnd(-50, 50);
          n2 = rnd(-50, 50);
          op = Math.random() < 0.5 ? '+' : '-';
          ans = op === '+' ? n1 + n2 : n1 - n2;
          break;
        }
      }

      return { num1: n1, num2: n2, op, answer: ans };
    }

    function renderAnswers(correct) {
      const allowNegative = state.difficulty === 'hard';
      const answers = new Set([correct]);

      while (answers.size < 4) {
        let wrong = correct + rnd(-10, 10);
        wrong = Math.round(wrong);

        // –Ω–∞ –ª—ë–≥–∫–æ–º/—Å—Ä–µ–¥–Ω–µ–º –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã
        if (!allowNegative && wrong < 0) continue;

        if (wrong !== correct) answers.add(wrong);
      }

      const shuffled = [...answers].sort(() => Math.random() - 0.5);
      el.answers.innerHTML = '';
      shuffled.forEach((ans, i) => {
        const btn = el.answerTpl.content.firstElementChild.cloneNode(true);
        btn.textContent = ans.toString();
        btn.setAttribute('data-value', ans);
        btn.setAttribute('aria-label', `–í–∞—Ä–∏–∞–Ω—Ç ${i + 1}: ${btn.textContent}`);
        btn.addEventListener('click', () => checkAnswer(ans, btn));
        el.answers.appendChild(btn);
      });
    }

    function checkAnswer(val, button) {
      [...el.answers.children].forEach((b) => (b.disabled = true));

      const isCorrect = almostEqual(val, state.correctAnswer);
      if (isCorrect) {
        button.classList.add('correct');
        state.correct++;
        state.streak++;
        const bonus = state.streak >= 3 ? 2 : 1;
        const timeBonus = Math.max(0, state.timeLeft - 5); // –±–æ–Ω—É—Å –∑–∞ —Å–∫–æ—Ä–æ—Å—Ç—å
        state.score += 10 * bonus + Math.floor(timeBonus / 3);
        celebrate('üëç');
        if (state.correct % 5 === 0) {
          state.level++;
          el.level.textContent = `–£—Ä–æ–≤–µ–Ω—å ${state.level}`;
          celebrate('üèÜ');
        }
      } else {
        button.classList.add('wrong');
        state.wrong++;
        state.streak = 0;
        // –ü–æ–¥—Å–≤–µ—Ç–∏–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π
        [...el.answers.children].forEach((b) => {
          const v = parseFloat(b.textContent);
          if (almostEqual(v, state.correctAnswer)) b.classList.add('correct');
        });
        celebrate('üòî');
      }

      renderStats();
      setTimeout(nextQuestion, 1100);
    }

    function markWrongDueToTime() {
      // –µ—Å–ª–∏ –≤—Ä–µ–º—è –≤—ã—à–ª–æ –∏ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –Ω–∏–∫—Ç–æ –Ω–µ –Ω–∞–∂–∞–ª
      const active = [...el.answers.children].some((b) => !b.disabled);
      if (active) {
        [...el.answers.children].forEach((b) => (b.disabled = true));
        state.wrong++; state.streak = 0;
        celebrate('‚è≥');
        // –ü–æ–¥—Å–≤–µ—Ç–∏–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π
        [...el.answers.children].forEach((b) => {
          const v = parseFloat(b.textContent);
          if (almostEqual(v, state.correctAnswer)) b.classList.add('correct');
        });
        renderStats();
        setTimeout(nextQuestion, 900);
      }
    }

    function renderStats() {
      el.correct.textContent = state.correct;
      el.wrong.textContent = state.wrong;
      el.score.textContent = state.score;
      el.streak.textContent = state.streak;

      const progress = state.total > 0 ? Math.round((state.correct / state.total) * 100) : 0;
      el.progressFill.style.width = progress + '%';
      el.progressFill.textContent = progress + '%';
      el.progressLabel.textContent = `${state.correct} –∏–∑ ${state.total}`;

      persist();
    }

    function celebrate(emoji) {
      const n = document.createElement('div');
      n.className = 'celebration';
      n.textContent = emoji;
      document.body.appendChild(n);
      setTimeout(() => n.remove(), 900);
    }

    // --- Persistence ---
    function persist() {
      const data = {
        score: state.score,
        correct: state.correct,
        wrong: state.wrong,
        level: state.level,
        streak: state.streak,
        total: state.total,
        difficulty: state.difficulty,
        lastPlayed: new Date().toISOString(),
      };
      try { localStorage.setItem('mathGameProgress_v2', JSON.stringify(data)); } catch (e) { /* quota? ignore */ }
    }

    function restore() {
      try {
        const raw = localStorage.getItem('mathGameProgress_v2');
        if (!raw) return;
        const d = JSON.parse(raw);
        state = { ...state, ...d };
        el.correct.textContent = state.correct || 0;
        el.wrong.textContent = state.wrong || 0;
        el.score.textContent = state.score || 0;
        el.streak.textContent = state.streak || 0;
        el.level.textContent = `–£—Ä–æ–≤–µ–Ω—å ${state.level || 1}`;
        el.progressLabel.textContent = `${state.correct || 0} –∏–∑ ${state.total || 0}`;
        const progress = state.total > 0 ? Math.round((state.correct / state.total) * 100) : 0;
        el.progressFill.style.width = progress + '%';
        el.progressFill.textContent = progress + '%';
      } catch (e) {}
    }

    // --- Utils ---
    function rnd(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }
    function round1(x) { return Math.round(x * 10) / 10; }
    function almostEqual(a, b) { return Math.abs(a - b) < 1e-9; }

    // –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫.
    setInterval(persist, 30000);

    // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    window.addEventListener('load', restore);
  </script>
</body>
</html>
